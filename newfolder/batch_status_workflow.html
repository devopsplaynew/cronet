<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Batch Dashboard</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<style>
/* === Global Styling === */
body {
    display: flex;
    margin: 0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    font-size: 14px;
    background-color: #f6f8fa;
    color: #212529;
}

/* === Sidebar === */
.sidebar {
    width: 240px;
    height: 100vh;
    background: linear-gradient(180deg, #212529 0%, #1a1f23 100%);
    border-right: 1px solid #2d3236;
    padding: 20px 15px;
    color: #fff;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.sidebar h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: #0dcaf0;
    text-align: center;
    letter-spacing: 1px;
}

.sidebar nav a {
    display: block;
    color: #adb5bd;
    margin-bottom: 12px;
    text-decoration: none;
    font-size: 15px;
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.2s;
    font-weight: 500;
}

.sidebar nav a:hover {
    background-color: #0d6efd;
    color: #fff;
}

/* === Main Content === */
.main-content {
    flex: 1;
    padding: 20px 25px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* === Filters === */
.filters {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    background: #fff;
    padding: 10px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

#business-date-filter {
    width: 140px;
    font-size: 13px;
    padding: 4px 8px;
}

#apply-filter {
    padding: 5px 14px;
    font-size: 13px;
    border-radius: 6px;
    font-weight: 500;
}

#refresh-btn {
    cursor: pointer;
    color: #0d6efd;
    font-size: 18px;
    transition: transform 0.2s;
}
#refresh-btn:hover {
    transform: rotate(180deg);
}

#last-refresh {
    font-size: 12px;
    color: #6c757d;
    margin-left: auto;
    font-style: italic;
}

/* === Charts Section === */
.chart-container {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    justify-content: flex-start;
}

.chart-box {
    flex: 0 0 150px;
    text-align: center;
    border-radius: 12px;
    padding: 12px;
    background: #fff;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
}
.chart-box:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.12);
}

.chart-title {
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 13px;
    color: #333;
    line-height: 1.3;
}

/* === Overall Status Chart (Sidebar Bottom) === */
#overall-status-chart-box {
    background: #2b343a;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    margin-top: 20px;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.4);
}
#overall-status-chart-box .chart-title {
    color: #f8f9fa;
    font-size: 14px;
    margin-bottom: 8px;
    font-weight: 600;
}

/* === Issues Table === */
.issues-table {
    margin-top: 25px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    padding: 15px;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #495057;
}

table.dataTable thead th {
    background: #f1f3f5;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
}

table.dataTable tbody td {
    vertical-align: middle;
    font-size: 13px;
    color: #212529;
}

/* === Status Badges === */
.badge-long-running {
    background-color: #fd7e14;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 6px;
}
.badge-failed {
    background-color: #dc3545;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 6px;
}
.badge-error {
    background-color: #6f42c1;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 6px;
}

/* === Flatpickr Tweaks === */
.flatpickr-calendar {
    font-family: inherit;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.flatpickr-day.selected {
    background: #0d6efd;
    border-color: #0d6efd;
}

/* === Processing Overlay === */
.processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.processing-overlay.visible {
    visibility: visible;
    opacity: 1;
}

.processing-spinner {
    font-size: 3rem;
    color: #0d6efd;
}

.processing-text {
    margin-top: 1rem;
    font-size: 1.2rem;
    color: #495057;
}
</style>

</head>
<body>
<!-- Processing Overlay -->
<div class="processing-overlay" id="processing-overlay">
    <div class="text-center">
        <div class="processing-spinner">
            <i class="bi bi-arrow-repeat spinner-rotate"></i>
        </div>
        <div class="processing-text">Loading data...</div>
    </div>
</div>

<div class="sidebar">
    <h2>CRONET</h2>
    <hr>
    <nav>
        <a href="/sla_monitor">SLA Monitor</a>
        <a href="/errors">Errors</a>
		<a href="/volume_trends">
  Volume Trends
</a>
    </nav>
    <!-- Overall Status Pie Chart at bottom -->
    <div id="overall-status-chart-box">
        <div class="chart-title">Overall Status</div>
        <canvas id="overallStatusChart" width="150" height="150"></canvas>
    </div>
</div>

<div class="main-content">
    <div class="filters">
        <input type="text" id="business-date-filter" class="form-control form-control-sm" placeholder="Select date">
        <button id="apply-filter" class="btn btn-sm btn-primary">Apply</button>
        <i id="refresh-btn" class="bi bi-arrow-clockwise" title="Manual refresh"></i>
        <span id="last-refresh"></span>
    </div>

    <div class="chart-container" id="charts"></div>

    <div class="issues-table">
        <div class="table-header">
        </div>
        <table id="issuesTable" class="table table-sm table-hover">
            <thead class="table-light">
                <tr>
                    <th>Client</th>
                    <th>Region</th>
                    <th>Workflow</th>
                    <th>Type</th>
                    <th>Last Updated</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
const statusColors = {
    'completed': '#28a745',
    'inprogress': '#ffc107',
    'pending': '#6c757d',
    'failed': '#dc3545',
    'long_running': '#fd7e14',
    'error': '#6f42c1'
};
const STORAGE_KEY = 'selectedBusinessDate';
let refreshInterval;
let issuesTable;
let flatpickrInstance;

// Show processing overlay
function showProcessing() {
    document.getElementById('processing-overlay').classList.add('visible');
}

// Hide processing overlay
function hideProcessing() {
    document.getElementById('processing-overlay').classList.remove('visible');
}

function initDataTable() {
    issuesTable = $('#issuesTable').DataTable({
        paging: true, pageLength: 10, lengthChange: false, searching: true, ordering: true, info: true, autoWidth: false,
        columns: [
            { data: 'client' },
            { data: 'region' },
            { data: 'workflow' },
            { data: 'type', render: (data) => {
                const badgeClass = data === 'long_running' ? 'badge-long-running' : data === 'failed' ? 'badge-failed' : 'badge-error';
                return `<span class="badge ${badgeClass}">${data.replace('_', ' ')}</span>`;
            }},
            { data: 'last_updated', render: (data) => data ? new Date(data).toLocaleString() : '' },
            { data: null, render: (data, type, row) => {
                const currentDate = flatpickrInstance && flatpickrInstance.selectedDates.length > 0 ? flatpickrInstance.selectedDates[0] : new Date();
                return `<a href="/details/${row.client}/${row.region}?business_date=${formatDate(currentDate)}" class="btn btn-sm btn-outline-primary">Details</a>`;
            }}
        ]
    });
}

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2,'0');
    const day = String(date.getDate()).padStart(2,'0');
    return `${year}-${month}-${day}`;
}

function updateLastRefreshTime() {
    document.getElementById('last-refresh').textContent = `Last refreshed: ${new Date().toLocaleTimeString()}`;
}

function updateIssuesTable(data) {
    if (!Array.isArray(data)) return;
    const issues = data.filter(item => ['long_running','failed','error'].includes(item.status_with_long_running || item.status))
        .map(item => ({
            client: item.client_cd,
            region: item.processing_region_cd,
            workflow: item.workflow_type.replace(/_/g,' '),
            type: item.status_with_long_running || item.status,
            last_updated: item.last_updated
        }));
    issuesTable.clear().rows.add(issues).draw();
}

async function fetchDataWithFilter() {
    showProcessing();
    
    try {
        let businessDate = flatpickrInstance && flatpickrInstance.selectedDates.length>0 ? formatDate(flatpickrInstance.selectedDates[0]) : formatDate(getPrevBusinessDay());
        const response = await fetch(`/api/batch_status?business_date=${businessDate}`);
        
        if(response.ok) {
            const json = await response.json();
            if(json.status==='success'){
                renderCharts(json.data);
                renderOverallStatus(json.data);
                updateIssuesTable(json.data);
                updateLastRefreshTime();
            }
        }
    } catch (error) {
        console.error('Error fetching data:', error);
    } finally {
        hideProcessing();
    }
}

function getPrevBusinessDay(){
    const d = new Date();
    d.setDate(d.getDate()-1);
    while(d.getDay()===0 || d.getDay()===6) d.setDate(d.getDate()-1);
    return d;
}

function groupByClientRegion(data){
    const grouped = {};
    data.forEach(item=>{
        const key = item.client_cd+'|'+item.processing_region_cd;
        if(!grouped[key]) grouped[key] = {client:item.client_cd, region:item.processing_region_cd, statuses:{}};
        const status = item.status_with_long_running || item.status;
        grouped[key].statuses[status] = (grouped[key].statuses[status]||0)+1;
    });
    return grouped;
}

// Client-Region Pie Charts
function renderCharts(data){
    const container = document.getElementById('charts');
    container.innerHTML = '';
    const grouped = groupByClientRegion(data);
    const currentDate = flatpickrInstance && flatpickrInstance.selectedDates.length>0 ? formatDate(flatpickrInstance.selectedDates[0]) : formatDate(getPrevBusinessDay());

    Object.entries(grouped).forEach(([key, group], index)=>{
        const chartId = "chart-"+index;
        const div = document.createElement('div');
        div.className = "chart-box";

        const statusCounts = group.statuses;
        const total = Object.values(statusCounts).reduce((a,b)=>a+b,0);

        let legendHtml = '';
        Object.keys(statusCounts).forEach(s=>{
            legendHtml += `<div><span class="status-circle" style="background:${statusColors[s]};"></span>${s}</div>`;
        });

        div.innerHTML = `<a href="/details/${group.client}/${group.region}?business_date=${currentDate}" style="text-decoration:none;color:inherit;">
                            <div class="chart-title">${group.client}<br>${group.region}</div>
                            <canvas id="${chartId}" width="100" height="100"></canvas>
                         </a>`;

        container.appendChild(div);

        new Chart(document.getElementById(chartId).getContext('2d'),{
            type:'pie',
            data:{ labels:Object.keys(statusCounts), datasets:[{ data:Object.values(statusCounts), backgroundColor:Object.keys(statusCounts).map(s=>statusColors[s]||'#6c757d'), borderWidth:1 }] },
            options:{
                responsive:true,
                maintainAspectRatio:true,
                plugins:{ legend:{display:false}, tooltip:{callbacks:{label:(ctx)=>`${ctx.label}: ${ctx.raw} (${Math.round((ctx.raw/total)*100)}%)`}}}
            }
        });
    });
}

// Overall Status Pie Chart
function renderOverallStatus(data){
    const statusCounts = {};
    data.forEach(item=>{
        const status = item.status_with_long_running || item.status;
        statusCounts[status] = (statusCounts[status]||0)+1;
    });
    const ctx = document.getElementById('overallStatusChart').getContext('2d');
    if(window.overallChart) window.overallChart.destroy();
    window.overallChart = new Chart(ctx,{
        type:'pie',
        data:{ labels:Object.keys(statusCounts), datasets:[{ data:Object.values(statusCounts), backgroundColor:Object.keys(statusCounts).map(s=>statusColors[s]||'#6c757d'), borderWidth:1 }] },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{ legend:{display:false}, tooltip:{callbacks:{label:(ctx)=>`${ctx.label}: ${ctx.raw}`}}}
        }
    });
}

document.addEventListener('DOMContentLoaded',function(){
    const savedDate = sessionStorage.getItem(STORAGE_KEY);
    flatpickrInstance = flatpickr("#business-date-filter",{
        dateFormat:"Y-m-d",
        defaultDate: savedDate || getPrevBusinessDay(),
        maxDate:"today",
        disable:[(date)=>(date.getDay()===0 || date.getDay()===6)],
        onChange:(selectedDates,dateStr)=>{
            sessionStorage.setItem(STORAGE_KEY,dateStr);
            fetchDataWithFilter();
        }
    });
    initDataTable();
    document.getElementById('apply-filter').addEventListener('click',fetchDataWithFilter);
    document.getElementById('refresh-btn').addEventListener('click',fetchDataWithFilter);
    fetchDataWithFilter();
    refreshInterval = setInterval(fetchDataWithFilter,60000);
});

window.addEventListener('beforeunload',()=>clearInterval(refreshInterval));
</script>
</body>
</html>