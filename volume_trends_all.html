<!DOCTYPE html>
<html>
<head>
  <title>Volume Trends - {{ region }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f9fafc;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .filter-panel {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h2 {
      margin-bottom: 20px;
      font-weight: 600;
      color: #333;
    }
    .chart-card {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center">ðŸ“Š Volume Trends ({{ region }})</h2>

    <!-- Filter Panel -->
    <div class="filter-panel row g-3">
      <div class="col-md-4">
        <label class="form-label">Client</label>
        <select id="clientFilter" class="form-select">
          <option value="ALL">ALL</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Region</label>
        <select id="regionFilter" class="form-select">
          <option value="ALL">ALL</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Snapshot</label>
        <select id="snapshotFilter" class="form-select">
          <option value="ALL">ALL</option>
        </select>
      </div>
    </div>

    <!-- Chart Card -->
    <div class="chart-card mt-4">
      <canvas id="volumeChart" height="120"></canvas>
    </div>
  </div>

  <script>
    const rawData = {{ data|tojson }};
    const labels = [...new Set(rawData.map(d => d.business_dt))];

    // populate filters
    const clients = [...new Set(rawData.map(d => d.client_cd))];
    const regions = [...new Set(rawData.map(d => d.processing_region_cd))];
    const snapshots = [...new Set(rawData.map(d => d.snapshot_type_cd))];

    clients.forEach(c => document.getElementById('clientFilter').insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
    regions.forEach(r => document.getElementById('regionFilter').insertAdjacentHTML('beforeend', `<option value="${r}">${r}</option>`));
    snapshots.forEach(s => document.getElementById('snapshotFilter').insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`));

    const ctx = document.getElementById('volumeChart').getContext('2d');
    let chart;

    function randomColor(seed) {
      // generate soft colors consistently for same key
      const hash = [...seed].reduce((a, c) => a + c.charCodeAt(0), 0);
      const hue = hash % 360;
      return `hsl(${hue},70%,55%)`;
    }

    function buildDatasets(filtered) {
      const grouped = {};
      filtered.forEach(d => {
        const key = d.client_cd + "-" + d.processing_region_cd + "-" + d.snapshot_type_cd;
        if (!grouped[key]) grouped[key] = {};
        grouped[key][d.business_dt] = d.total_records;
      });

      return Object.keys(grouped).map(key => {
        return {
          label: key,
          data: labels.map(date => grouped[key][date] || 0),
          borderWidth: 2,
          fill: false,
          borderColor: randomColor(key),
          backgroundColor: randomColor(key),
          tension: 0.3  // smooth curves
        };
      });
    }

    function updateChart() {
      const client = document.getElementById('clientFilter').value;
      const region = document.getElementById('regionFilter').value;
      const snapshot = document.getElementById('snapshotFilter').value;

      const filtered = rawData.filter(d =>
        (client === "ALL" || d.client_cd === client) &&
        (region === "ALL" || d.processing_region_cd === region) &&
        (snapshot === "ALL" || d.snapshot_type_cd === snapshot)
      );

      const datasets = buildDatasets(filtered);

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { mode: 'index', intersect: false }
          },
          interaction: { mode: 'nearest', intersect: false },
          scales: {
            x: { title: { display: true, text: 'Business Date' } },
            y: { title: { display: true, text: 'Records Count' }, beginAtZero: true }
          }
        }
      });
    }

    document.getElementById('clientFilter').addEventListener('change', updateChart);
    document.getElementById('regionFilter').addEventListener('change', updateChart);
    document.getElementById('snapshotFilter').addEventListener('change', updateChart);

    // first draw
    updateChart();
  </script>
</body>
</html>
